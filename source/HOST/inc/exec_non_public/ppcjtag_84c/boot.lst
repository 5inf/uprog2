GAS LISTING boot.vleasm 			page 1


   1              	#################################################################################
   2              	#										#
   3              	# SPC560P-Bootcode for uprog2 (JTAG mode)					#
   4              	# version 1.00									#
   5              	#										#
   6              	# copyright (c) 2016-2017 Joerg Wolfram (joerg@jcwolfram.de)			#
   7              	#										#
   8              	# This program is free software; you can redistribute it and/or			#
   9              	# modify it under the terms of the GNU General Public License			#
  10              	# as published by the Free Software Foundation; either version 2		#
  11              	# of the License, or (at your option) any later version.			#
  12              	#										#
  13              	# This program is distributed in the hope that it will be useful,		#
  14              	# but WITHOUT ANY WARRANTY; without even the implied warranty of		#
  15              	# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.See the GNU		#
  16              	# General Public License for more details.					#
  17              	#										#
  18              	# You should have received a copy of the GNU General Public			#
  19              	# License along with this library; if not, write to the				#
  20              	# Free Software Foundation, Inc., 59 Temple Place - Suite 330,			#
  21              	# Boston, MA 02111-1307, USA.							#
  22              	#										#
  23              	#################################################################################
  24              	
  25              				.include "/usr/local/toolchain/powerpc-vle-elf/include_asm/regs_spc584c.asm"
   1              		.equ	r0,0
   2              		.equ	r1,1
   3              		.equ	rsp,1
   4              		.equ	r2,2
   5              		.equ	r3,3
   6              		.equ	r4,4
   7              		.equ	r5,5
   8              		.equ	r6,6
   9              		.equ	r7,7
  10              		.equ	r8,8
  11              		.equ	r9,9
  12              		.equ	r10,10
  13              		.equ	r11,11
  14              		.equ	r12,12
  15              		.equ	r13,13
  16              		.equ	r14,14
  17              		.equ	r15,15
  18              		.equ	r16,16
  19              		.equ	r17,17
  20              		.equ	r18,18
  21              		.equ	r19,19
  22              		.equ	r20,20
  23              		.equ	r21,21
  24              		.equ	r22,22
  25              		.equ	r23,23
  26              		.equ	r24,24
  27              		.equ	r25,25
  28              		.equ	r26,26
  29              		.equ	r27,27
  30              		.equ	r28,28
  31              		.equ	r29,29
  32              		.equ	r30,30
GAS LISTING boot.vleasm 			page 2


  33              		.equ	r31,31
  34              		.equ	rsp,1
  35              	
  36              		.equ	SIUL_BASE,0xF7FC
  37              		#port output (4 bits per WORD)
  38              		.equ	GPDO0,0x1300	#PA 0-3
  39              		.equ	GPDO1,0x1304	#PA 4-7
  40              		.equ	GPDO2,0x1308	#PA 8-11
  41              		.equ	GPDO3,0x130c	#PA 12-15
  42              	
  43              		.equ	GPDO4,0x1310	#PB 0-3
  44              		.equ	GPDO5,0x1314	#PB 4-7
  45              		.equ	GPDO6,0x1318	#PB 8-11
  46              		.equ	GPDO7,0x131c	#PB 12-15
  47              	
  48              		.equ	GPDO8,0x1320	#PC 0-3
  49              		.equ	GPDO9,0x1324	#PC 4-7
  50              		.equ	GPDO10,0x1328	#PC 8-11
  51              		.equ	GPDO11,0x132c	#PC 12-15
  52              	
  53              		.equ	GPDO12,0x1330	#PD 0-3
  54              		.equ	GPDO13,0x1334	#PD 4-7
  55              		.equ	GPDO14,0x1338	#PD 8-11
  56              		.equ	GPDO15,0x133c	#PD 12-15
  57              	
  58              		.equ	GPDO16,0x1340	#PE 0-3
  59              		.equ	GPDO17,0x1344	#PE 4-7
  60              		.equ	GPDO18,0x1348	#PE 8-11
  61              		.equ	GPDO19,0x134c	#PE 12-15
  62              	
  63              		.equ	GPDO20,0x1350	#PF 0-3
  64              		.equ	GPDO21,0x1354	#PF 4-7
  65              		.equ	GPDO22,0x1358	#PF 8-11
  66              		.equ	GPDO23,0x135c	#PF 12-15
  67              	
  68              		.equ	GPDO24,0x1360	#PG 0-3
  69              		.equ	GPDO25,0x1364	#PG 4-7
  70              		.equ	GPDO26,0x1368	#PG 8-11
  71              		.equ	GPDO27,0x136c	#PG 12-15
  72              	
  73              		.equ	GPDO28,0x1370	#PH 0-3
  74              		.equ	GPDO29,0x1374	#PH 4-7
  75              		.equ	GPDO30,0x1378	#PH 8-11
  76              		.equ	GPDO31,0x137c	#PH 12-15
  77              	
  78              		.equ	GPDO32,0x1380	#PI 0-3
  79              		.equ	GPDO33,0x1384	#PI 4-7
  80              		.equ	GPDO34,0x1388	#PI 8-11
  81              		.equ	GPDO35,0x138c	#PI 12-15
  82              	
  83              		.equ	GPDO36,0x1390	#PJ 0-3
  84              		.equ	GPDO37,0x1394	#PJ 4-7
  85              		.equ	GPDO38,0x1398	#PJ 8-11
  86              		.equ	GPDO39,0x139c	#PJ 12-15
  87              	
  88              		#port input (4 bits per WORD)
  89              		.equ	GPDI0,0x1500	#PA 0-3
GAS LISTING boot.vleasm 			page 3


  90              		.equ	GPDI1,0x1504	#PA 4-7
  91              		.equ	GPDI2,0x1508	#PA 8-11
  92              		.equ	GPDI3,0x150c	#PA 12-15
  93              	
  94              		.equ	GPDI4,0x1510	#PB 0-3
  95              		.equ	GPDI5,0x1514	#PB 4-7
  96              		.equ	GPDI6,0x1518	#PB 8-11
  97              		.equ	GPDI7,0x151c	#PB 12-15
  98              	
  99              		.equ	GPDI8,0x1520	#PC 0-3
 100              		.equ	GPDI9,0x1524	#PC 4-7
 101              		.equ	GPDI10,0x1528	#PC 8-11
 102              		.equ	GPDI11,0x152c	#PC 12-15
 103              	
 104              		.equ	GPDI12,0x1530	#PD 0-3
 105              		.equ	GPDI13,0x1534	#PD 4-7
 106              		.equ	GPDI14,0x1538	#PD 8-11
 107              		.equ	GPDI15,0x153c	#PD 12-15
 108              	
 109              		.equ	GPDI16,0x1540	#PE 0-3
 110              		.equ	GPDI17,0x1544	#PE 4-7
 111              		.equ	GPDI18,0x1548	#PE 8-11
 112              		.equ	GPDI19,0x154c	#PE 12-15
 113              	
 114              		.equ	GPDI20,0x1550	#PF 0-3
 115              		.equ	GPDI21,0x1554	#PF 4-7
 116              		.equ	GPDI22,0x1558	#PF 8-11
 117              		.equ	GPDI23,0x155c	#PF 12-15
 118              	
 119              		.equ	GPDI24,0x1560	#PG 0-3
 120              		.equ	GPDI25,0x1564	#PG 4-7
 121              		.equ	GPDI26,0x1568	#PG 8-11
 122              		.equ	GPDI27,0x156c	#PG 12-15
 123              	
 124              		.equ	GPDI28,0x1570	#PH 0-3
 125              		.equ	GPDI29,0x1574	#PH 4-7
 126              		.equ	GPDI30,0x1578	#PH 8-11
 127              		.equ	GPDI31,0x157c	#PH 12-15
 128              	
 129              		.equ	GPDI32,0x1580	#PI 0-3
 130              		.equ	GPDI33,0x1584	#PI 4-7
 131              		.equ	GPDI34,0x1588	#PI 8-11
 132              		.equ	GPDI35,0x158c	#PI 12-15
 133              	
 134              		.equ	GPDI36,0x1590	#PJ 0-3
 135              		.equ	GPDI37,0x1594	#PJ 4-7
 136              		.equ	GPDI38,0x1598	#PJ 8-11
 137              		.equ	GPDI39,0x159c	#PJ 12-15
 138              	
 139              	
 140              		#port output (32 bits per WORD)
 141              		.equ	PGPDO0,0x1700		# PORT A+B
 142              		.equ	PGPDO1,0x1704		# PORT C+D
 143              		.equ	PGPDO2,0x1708		# PORT E+F
 144              		.equ	PGPDO3,0x170C		# PORT G+H
 145              		.equ	PGPDO4,0x1710		# PORT I+J
 146              		.equ	POUT_A,PGPDO0		# PORT A
GAS LISTING boot.vleasm 			page 4


 147              		.equ	POUT_B,PGPDO0+2		# PORT B
 148              		.equ	POUT_C,PGPDO1		# PORT C
 149              		.equ	POUT_D,PGPDO1+2		# PORT D
 150              		.equ	POUT_E,PGPDO2		# PORT E
 151              		.equ	POUT_F,PGPDO2+2		# PORT F
 152              		.equ	POUT_G,PGPDO3		# PORT G
 153              		.equ	POUT_H,PGPDO3+2		# PORT H
 154              		.equ	POUT_I,PGPDO4		# PORT I
 155              		.equ	POUT_J,PGPDO4+2		# PORT j
 156              	
 157              		#port input (32 bits per WORD)
 158              		.equ	PGPDI0,0x1740		# PORT A+B
 159              		.equ	PGPDI1,0x1744		# PORT C+D
 160              		.equ	PGPDI2,0x1748		# PORT E+F
 161              		.equ	PGPDI3,0x174C		# PORT G+H
 162              		.equ	PGPDI4,0x1750		# PORT I+J
 163              		.equ	PIN_A,PGPDI0		# PORT A
 164              		.equ	PIN_B,PGPDI0+2		# PORT B
 165              		.equ	PIN_C,PGPDI1		# PORT C
 166              		.equ	PIN_D,PGPDI1+2		# PORT D
 167              		.equ	PIN_E,PGPDI2		# PORT E
 168              		.equ	PIN_F,PGPDI2+2		# PORT F
 169              		.equ	PIN_G,PGPDI3		# PORT G
 170              		.equ	PIN_H,PGPDI3+2		# PORT H
 171              		.equ	PIN_I,PGPDI4		# PORT I
 172              		.equ	PIN_J,PGPDI4+2		# PORT J
 173              	
 174              		#port config registers
 175              		.equ	MCSR_A0,0x0240		# PA[0]
 176              		.equ	MCSR_A1,0x0244		# PA[1]
 177              		.equ	MCSR_A2,0x0248		# PA[2]
 178              		.equ	MCSR_A3,0x024C		# PA[3]
 179              		.equ	MCSR_A4,0x0250		# PA[4]
 180              		.equ	MCSR_A5,0x0254		# PA[5]
 181              		.equ	MCSR_A6,0x0258		# PA[6]
 182              		.equ	MCSR_A7,0x025C		# PA[7]
 183              		.equ	MCSR_A8,0x0260		# PA[8]
 184              		.equ	MCSR_A9,0x0264		# PA[9]
 185              		.equ	MCSR_A10,0x0268		# PA[10]
 186              		.equ	MCSR_A11,0x026C		# PA[11]
 187              		.equ	MCSR_A12,0x0270		# PA[12]
 188              		.equ	MCSR_A13,0x0274		# PA[13]
 189              		.equ	MCSR_A14,0x0278		# PA[14]
 190              		.equ	MCSR_A15,0x027C		# PA[15]
 191              	
 192              		.equ	MCSR_B0,0x0280		# PB[0]
 193              		.equ	MCSR_B1,0x0284		# PB[1]
 194              		.equ	MCSR_B2,0x0288		# PB[2]
 195              		.equ	MCSR_B3,0x028C		# PB[3]
 196              		.equ	MCSR_B4,0x0290		# PB[4]
 197              		.equ	MCSR_B5,0x0294		# PB[5]
 198              		.equ	MCSR_B6,0x0298		# PB[6]
 199              		.equ	MCSR_B7,0x029C		# PB[7]
 200              		.equ	MCSR_B8,0x02A0		# PB[8]
 201              		.equ	MCSR_B9,0x02A4		# PB[9]
 202              		.equ	MCSR_B10,0x02A8		# PB[10]
 203              		.equ	MCSR_B11,0x02AC		# PB[11]
GAS LISTING boot.vleasm 			page 5


 204              		.equ	MCSR_B12,0x02B0		# PB[12]
 205              		.equ	MCSR_B13,0x02B4		# PB[13]
 206              		.equ	MCSR_B14,0x02B8		# PB[14]
 207              		.equ	MCSR_B15,0x02BC		# PB[15]
 208              	
 209              		.equ	MCSR_C0,0x02C0		# PC[0]
 210              		.equ	MCSR_C1,0x02C4		# PC[1]
 211              		.equ	MCSR_C2,0x02C8		# PC[2]
 212              		.equ	MCSR_C3,0x02CC		# PC[3]
 213              		.equ	MCSR_C4,0x02D0		# PC[4]
 214              		.equ	MCSR_C5,0x02D4		# PC[5]
 215              		.equ	MCSR_C6,0x02D8		# PC[6]
 216              		.equ	MCSR_C7,0x02DC		# PC[7]
 217              		.equ	MCSR_C8,0x02E0		# PC[8]
 218              		.equ	MCSR_C9,0x02E4		# PC[9]
 219              		.equ	MCSR_C10,0x02E8		# PC[10]
 220              		.equ	MCSR_C11,0x02EC		# PC[11]
 221              		.equ	MCSR_C12,0x02F0		# PC[12]
 222              		.equ	MCSR_C13,0x02F4		# PC[13]
 223              		.equ	MCSR_C14,0x02F8		# PC[14]
 224              		.equ	MCSR_C15,0x02FC		# PC[15]
 225              	
 226              		.equ	MCSR_D0,0x0300		# PD[0]
 227              		.equ	MCSR_D1,0x0304		# PD[1]
 228              		.equ	MCSR_D2,0x0308		# PD[2]
 229              		.equ	MCSR_D3,0x030C		# PD[3]
 230              		.equ	MCSR_D4,0x0310		# PD[4]
 231              		.equ	MCSR_D5,0x0314		# PD[5]
 232              		.equ	MCSR_D6,0x0318		# PD[6]
 233              		.equ	MCSR_D7,0x031C		# PD[7]
 234              		.equ	MCSR_D8,0x0320		# PD[8]
 235              		.equ	MCSR_D9,0x0324		# PD[9]
 236              		.equ	MCSR_D10,0x0328		# PD[10]
 237              		.equ	MCSR_D11,0x032C		# PD[11]
 238              		.equ	MCSR_D12,0x0330		# PD[12]
 239              		.equ	MCSR_D13,0x0334		# PD[13]
 240              		.equ	MCSR_D14,0x0338		# PD[14]
 241              		.equ	MCSR_D15,0x033C		# PD[15]
 242              	
 243              		.equ	MCSR_E0,0x0340		# PE[0]
 244              		.equ	MCSR_E1,0x0344		# PE[1]
 245              		.equ	MCSR_E2,0x0348		# PE[2]
 246              		.equ	MCSR_E3,0x034C		# PE[3]
 247              		.equ	MCSR_E4,0x0350		# PE[4]
 248              		.equ	MCSR_E5,0x0354		# PE[5]
 249              		.equ	MCSR_E6,0x0358		# PE[6]
 250              		.equ	MCSR_E7,0x035C		# PE[7]
 251              		.equ	MCSR_E8,0x0360		# PE[8]
 252              		.equ	MCSR_E9,0x0364		# PE[9]
 253              		.equ	MCSR_E10,0x0368		# PE[10]
 254              		.equ	MCSR_E11,0x036C		# PE[11]
 255              		.equ	MCSR_E12,0x0370		# PE[12]
 256              		.equ	MCSR_E13,0x0374		# PE[13]
 257              		.equ	MCSR_E14,0x0378		# PE[14]
 258              		.equ	MCSR_E15,0x037C		# PE[15]
 259              	
 260              		.equ	MCSR_F0,0x0380		# PF[0]
GAS LISTING boot.vleasm 			page 6


 261              		.equ	MCSR_F1,0x0384		# PF[1]
 262              		.equ	MCSR_F2,0x0388		# PF[2]
 263              		.equ	MCSR_F3,0x038C		# PF[3]
 264              		.equ	MCSR_F4,0x0390		# PF[4]
 265              		.equ	MCSR_F5,0x0394		# PF[5]
 266              		.equ	MCSR_F6,0x0398		# PF[6]
 267              		.equ	MCSR_F7,0x039C		# PF[7]
 268              		.equ	MCSR_F8,0x03A0		# PF[8]
 269              		.equ	MCSR_F9,0x03A4		# PF[9]
 270              		.equ	MCSR_F10,0x03A8		# PF[10]
 271              		.equ	MCSR_F11,0x03AC		# PF[11]
 272              		.equ	MCSR_F12,0x03B0		# PF[12]
 273              		.equ	MCSR_F13,0x03B4		# PF[13]
 274              		.equ	MCSR_F14,0x03B8		# PF[14]
 275              		.equ	MCSR_F15,0x03BC		# PF[15]
 276              		
 277              		.equ	MCSR_G0,0x03C0		# PG[0]
 278              		.equ	MCSR_G1,0x03C4		# PG[1]
 279              		.equ	MCSR_G2,0x03C8		# PG[2]
 280              		.equ	MCSR_G3,0x03CC		# PG[3]
 281              		.equ	MCSR_G4,0x03D0		# PG[4]
 282              		.equ	MCSR_G5,0x03D4		# PG[5]
 283              		.equ	MCSR_G6,0x03D8		# PG[6]
 284              		.equ	MCSR_G7,0x03DC		# PG[7]
 285              		.equ	MCSR_G8,0x03E0		# PG[8]
 286              		.equ	MCSR_G9,0x03E4		# PG[9]
 287              		.equ	MCSR_G10,0x03E8		# PG[10]
 288              		.equ	MCSR_G11,0x03EC		# PG[11]
 289              		.equ	MCSR_G12,0x03F0		# PG[12]
 290              		.equ	MCSR_G13,0x03F4		# PG[13]
 291              		.equ	MCSR_G14,0x03F8		# PG[14]
 292              		.equ	MCSR_G15,0x03FC		# PG[15]
 293              	
 294              		.equ	MCSR_H0,0x0400		# PH[0]
 295              		.equ	MCSR_H1,0x0404		# PH[1]
 296              		.equ	MCSR_H2,0x0408		# PH[2]
 297              		.equ	MCSR_H3,0x040C		# PH[3]
 298              		.equ	MCSR_H4,0x0410		# PH[4]
 299              		.equ	MCSR_H5,0x0414		# PH[5]
 300              		.equ	MCSR_H6,0x0418		# PH[6]
 301              		.equ	MCSR_H7,0x041C		# PH[7]
 302              		.equ	MCSR_H8,0x0420		# PH[8]
 303              		.equ	MCSR_H9,0x0424		# PH[9]
 304              		.equ	MCSR_H10,0x0428		# PH[10]
 305              		.equ	MCSR_H11,0x042C		# PH[11]
 306              		.equ	MCSR_H12,0x0430		# PH[12]
 307              		.equ	MCSR_H13,0x0434		# PH[13]
 308              		.equ	MCSR_H14,0x0438		# PH[14]
 309              		.equ	MCSR_H15,0x043C		# PH[15]
 310              	
 311              		.equ	MCSR_I0,0x0440		# PI[0]
 312              		.equ	MCSR_I1,0x0444		# Pi[1]
 313              		.equ	MCSR_I2,0x0448		# PI[2]
 314              		.equ	MCSR_I3,0x044C		# PI[3]
 315              		.equ	MCSR_I4,0x0450		# PI[4]
 316              		.equ	MCSR_I5,0x0454		# PI[5]
 317              		.equ	MCSR_I6,0x0458		# PI[6]
GAS LISTING boot.vleasm 			page 7


 318              		.equ	MCSR_I7,0x045C		# PI[7]
 319              		.equ	MCSR_I8,0x0460		# PI[8]
 320              		.equ	MCSR_I9,0x0464		# PI[9]
 321              		.equ	MCSR_I10,0x0468		# PI[10]
 322              		.equ	MCSR_I11,0x046C		# PI[11]
 323              		.equ	MCSR_I12,0x0470		# PI[12]
 324              		.equ	MCSR_I13,0x0474		# PI[13]
 325              		.equ	MCSR_I14,0x0478		# PI[14]
 326              		.equ	MCSR_I15,0x047C		# PI[15]
 327              	
 328              		.equ	MCSR_J0,0x0480		# PJ[0]
 329              		.equ	MCSR_J1,0x0484		# PJ[1]
 330              		.equ	MCSR_J2,0x0488		# PJ[2]
 331              		.equ	MCSR_J3,0x048C		# PJ[3]
 332              		.equ	MCSR_J4,0x0490		# PJ[4]
 333              		.equ	MCSR_J5,0x0494		# PJ[5]
 334              		.equ	MCSR_J6,0x0498		# PJ[6]
 335              		.equ	MCSR_J7,0x049C		# PJ[7]
 336              		.equ	MCSR_J8,0x04A0		# PJ[8]
 337              		.equ	MCSR_J9,0x04A4		# PJ[9]
 338              		.equ	MCSR_J10,0x04A8		# PJ[10]
 339              		.equ	MCSR_J11,0x04AC		# PJ[11]
 340              		.equ	MCSR_J12,0x04B0		# PJ[12]
 341              		.equ	MCSR_J13,0x04B4		# PJ[13]
 342              		.equ	MCSR_J14,0x04B8		# PJ[14]
 343              		.equ	MCSR_J15,0x04BC		# PJ[15]
 344              	
 345              		#port config register defaults
 346              		.equ	MCSR_UNCONNECT,0x0003
 347              		.equ	MCSR_INPUT,0x0088
 348              		.equ	MCSR_INPUT_PU,0x0089
 349              		.equ	MCSR_INPUT_PD,0x008A
 350              		.equ	MCSR_OUTPUT,0x2288
 351              		.equ	MCSR_OUTPUT_OD,0x2188
 352              	
 353              		#SWT
 354              		.equ	SWT_BASE,0xF405
 355              		.equ	SWT_CR,0x8000
 356              		.equ	SWT_IR,0x8004
 357              		.equ	SWT_TO,0x8008
 358              		.equ	SWT_WN,0x800c
 359              		.equ	SWT_SR,0x8010
 360              		.equ	SWT_CO,0x8014
 361              		.equ	SWT_SK,0x8018
 362              	
 363              		.equ	ME_BASE,0xF7FB
 364              		.equ	ME_GS,0x8000
 365              		.equ	ME_MCTL,0x8004
 366              		.equ	ME_ME,0x8008
 367              		.equ	ME_MIS,0x800C
 368              		.equ	ME_IM,0x8010
 369              		.equ	ME_IMTS,0x8014
 370              		.equ	ME_DMTS,0x8018
 371              		.equ	ME_RUN_PC0,0x8080
 372              		.equ	ME_RUN_PC1,0x8084
 373              		.equ	ME_RUN_PC2,0x8088
 374              		.equ	ME_RUN_PC3,0x808c
GAS LISTING boot.vleasm 			page 8


 375              		.equ	ME_RUN_PC4,0x8090
 376              		.equ	ME_RUN_PC5,0x8094
 377              		.equ	ME_RUN_PC6,0x8098
 378              		.equ	ME_RUN_PC7,0x809c
 379              		.equ	ME_DRUN_MC,0x802c
 380              	
 381              		.equ	FMPLL_BASE,0xc3fe
 382              		.equ	FMPLL0_CR,0x00a0
 383              		.equ	FMPLL1_CR,0x00c0
 384              	
 385              		.equ	LINFLEX0_BASE,0xffe4
 386              		.equ	LINFLEX0_LINCR1,0x0000
 387              		.equ	LINFLEX0_UARTCR,0x0010
 388              		.equ	LINFLEX0_UARTSR,0x0014
 389              		.equ	LINFLEX0_LINBRR,0x0028
 390              		.equ	LINFLEX0_LINBFRR,0x002C
 391              		.equ	LINFLEX0_BRDL,0x0038
 392              		.equ	LINFLEX0_BRDM,0x003C
 393              		
 394              		.equ	PFLASH_BASE,0xc3f8
 395              		.equ	PFLASH_MCR,0x8000
 396              		.equ	PFLASH_LML,0x8004
 397              		.equ	PFLASH_LMS,0x8010
 398              	
 399              		.equ	PFLASH_BASE_N,0xc3f9
 400              		.equ	PFLASH_MCR_N,0xFFFF8000
 401              		.equ	PFLASH_LMS_N,0xFFFF8010
 402              	
 403              		.equ	DFLASH_BASE,0xc3f8
 404              		.equ	DFLASH_MCR,0xC000
 405              	
 406              		.equ	INTC_BASE,0xfff48000
 407              		.equ	INTC_IACKR,0xfff48010
 408              		.equ	INTC_EOIR,0xfff48018
 409              	
  26              	
  27              				.equ	block_size,2048
  28              	
  29              				.equ	shadow_unlock_lo,	0xffff
  30              				.equ	shadow_unlock_hi,	0xffef
  31              	
  32              	
  33              	################################################################################
  34              	# debug LED (PB0/PB1)
  35              	################################################################################
  36              				.equ	DEBUG_LED,1		# enable LED debug
  37              	
  38              				.text
  39 ???? 00000000 				.org 0x00100
  39      00000000 
  39      00000000 
  39      00000000 
  39      00000000 
  40              	
  41              	main_start:		#remove watchdog softlock
  42 ???? 731EE405 				e_lis		r24,SWT_BASE
  43 ???? 73300010 				e_li		r25,SWT_SR		# service register
GAS LISTING boot.vleasm 			page 9


  44 ???? 4489     				se_or		r25,r24
  45 ???? 73980520 				e_li		r28,0xc520		# passwd 1
  46 ???? 57990000 				e_stw		r28,0(r25)
  47 ???? 739B0128 				e_li		r28,0xd928		# passwd2
  48 ???? 57990000 				e_stw		r28,0(r25)
  49              	
  50              				#watchdog off
  51 ???? 73300000 				e_li		r25,SWT_CR
  52 ???? 4489     				se_or		r25,r24
  53 ???? 53990000 				e_lwz		r28,0(r25)
  54 ???? 779C003D 				e_clrrwi	r28,r28,1		# clear bit 0
  55 ???? 57990000 				e_stw		r28,0(r25)
  56              	
  57              	
  58              	################################################################################
  59              	# set mode
  60              	################################################################################
  61 ???? 731EE7FB 				e_lis		r24,ME_BASE
  62 ???? 7330002C 				e_li		r25,ME_DRUN_MC
  63 ???? 4489     				se_or		r25,r24
  64 ???? 73A0E09F 				e_lis		r29,0x009F		#DRUN
  65 ???? 73800010 				e_li		r28,0x0010
  66 ???? 44DC     				se_or		r28,r29
  67 ???? D0C9     				se_stw		r28,0(r25)
  68              	
  69 ???? 7028E000 				e_lis		rsp,0x4000		#set stack pointer
  70 ???? 732C0000 				e_li		r25,0x6000
  71 ???? 4491     				se_or		rsp,r25
  72              	
  73 ???? 731EE7FB 				e_lis		r24,ME_BASE
  74 ???? 73300080 				e_li		r25,ME_RUN_PC0
  75 ???? 4489     				se_or		r25,r24
  76 ???? 738000FE 				e_li		r28,0xfe
  77 ???? 57990000 				e_stw		r28,0(r25)
  78              	
  79 ???? 73300004 				e_li		r25,ME_MCTL
  80 ???? 4489     				se_or		r25,r24
  81 ???? 73A6E000 				e_lis		r29,0x3000		#DRUN
  82 ???? 738B02F0 				e_li		r28,0x5af0
  83 ???? 44DC     				se_or		r28,r29
  84 ???? D0C9     				se_stw		r28,0(r25)
  85 ???? 7394050F 				e_li		r28,0xa50f
  86 ???? 44DC     				se_or		r28,r29
  87 ???? D0C9     				se_stw		r28,0(r25)
  88              	
  89 ???? 7388E000 				e_lis		r28,0x4000		#f * 4
  90 ???? 73A10000 				e_li		r29,0x0800
  91 ???? 44DC     				se_or		r28,r29
  92 ???? 73C00000 				e_li		r30,0x00
  93 ???? 73600000 				e_li		r27,0x00
  94 ???? 57DC0000 	rfill_1:		e_stw		r30,0(r28)
  95 ???? 1F9C0004 				e_add16i	r28,r28,4
  96 ???? 1F7B0001 				e_add16i	r27,r27,1
  97 ???? 707B9E00 				e_cmp16i	r27,0x1e00
  98 ???? E2F8     				se_bne		rfill_1
  99              	
 100              	
GAS LISTING boot.vleasm 			page 10


 101              	################################################################################
 102              	# set IO
 103              	################################################################################
 104 ???? 731EE7FC 				e_lis		r24,SIUL_BASE
 105 ???? 73200000 				e_li		r25,PCR16
 106 ???? 4489     				se_or		r25,r24
 107 ???? 73800400 				e_li		r28,0x0400		#LINFLEX 0 output
 108 ???? B2C9     				se_sth		r28,0x4(r25)
 109 ???? 73800103 				e_li		r28,0x0103		#LINFLEX 0 input
 110 ???? B3C9     				se_sth		r28,0x6(r25)
 111              	
 112              	.if LED_DEBUG == 1
 113              				e_li		r25,PCR87		#LED
 114              				se_or		r25,r24
 115              				e_li		r28,0x0204
 116              				se_sth		r28,0x0(r25)
 117              				se_sth		r28,0x2(r25)
 118              	.endif
 119              	
 120              	
 121              	################################################################################
 122              	# prepare flash
 123              	# R26 = main flash base
 124              	# R25 = data flash base
 125              	################################################################################
 126 ???? 7358E3F8 				e_lis		r26,PFLASH_BASE		# MCR address
 127 ???? 70F00000 				e_li		r7,PFLASH_MCR
 128 ???? 447A     				se_or		r26,r7
 129              	
 130 ???? 7338E3F8 				e_lis		r25,DFLASH_BASE		# MCR address
 131 ???? 70F80000 				e_li		r7,DFLASH_MCR
 132 ???? 4479     				se_or		r25,r7
 133              	
 134 ???? 7374E1A1 				e_lis		r27,0xa1a1		# password LML
 135 ???? 70E20111 				e_li		r7,0x1111
 136 ???? 447B     				se_or		r27,r7
 137 ???? D1BA     				se_stw		r27,4(r26)		# main flash
 138 ???? D1B9     				se_stw		r27,4(r25)		# data flash
 139              	
 140 ???? 7376E2B2 				e_lis		r27,0xb2b2		# password HBL
 141 ???? 70E40222 				e_li		r7,0x2222
 142 ???? 447B     				se_or		r27,r7
 143 ???? D2BA     				se_stw		r27,8(r26)		# main flash
 144 ???? D2B9     				se_stw		r27,8(r25)		# data flash
 145              	
 146 ???? 7378E3C3 				e_lis		r27,0xc3c3		# password SLL
 147 ???? 70E60333 				e_li		r7,0x3333
 148 ???? 447B     				se_or		r27,r7
 149 ???? D3BA     				se_stw		r27,12(r26)		# main flash
 150 ???? D3B9     				se_stw		r27,12(r25)		# data flash
 151              	
 152 ???? 78000229 				e_bl		enable_none
 153 ???? 70800400 				e_li		r4,0x0400		# DONE mask
 154              	
 155              	#			e_li		r29,0xccdd
 156              	#			e_lis		r24,0x4000
 157              	#			e_stw		r29,0x04F8(r24)		#store 0
GAS LISTING boot.vleasm 			page 11


 158              	
 159              	#zoo:			e_b		zoo
 160              	
 161              	
 162              	################################################################################
 163              	# the main loop
 164              	################################################################################
 165              	main_xloop:
 166              	.if DEBUG_LED == 1
 167 ???? 780000E7 				e_bl		led_green		# ready
 168              	.endif
 169 ???? 78000109 				e_bl		wait_cmd		# wait for command
 170              	.if DEBUG_LED == 1
 171 ???? 780000B9 				e_bl		led_red			# busy
 172              	.endif
 173              	
 174              	
 175              	################################################################################
 176              	# 0x0D = program code
 177              	################################################################################
 178 ???? 701D980D 	main_program:		e_cmp16i	r29,0x0D		# program main flash code
 179 ???? E205     				se_bne		main_erase
 180 ???? 7800015F 				e_bl		enable_main		# enable main flash
 181 ???? 7800004A 				e_b		do_prog
 182              	
 183              	
 184              	################################################################################
 185              	# 0x15 = erase
 186              	################################################################################
 187              	main_erase:	#	se_b		main_erase
 188 ???? 701D9815 				e_cmp16i	r29,0x15		# erase?
 189 ???? E205     				se_bne		shadow_program
 190 ???? 78000151 				e_bl		enable_main		# enable shadow
 191 ???? 7800007E 				e_b		do_erase
 192              	
 193              	
 194              	################################################################################
 195              	# 0x0E = program shadow
 196              	################################################################################
 197 ???? 701D980E 	shadow_program:		e_cmp16i	r29,0x0E		# shadow prog code
 198 ???? E205     				se_bne		shadow_erase
 199 ???? 78000187 				e_bl		enable_shadow		# enable shadow
 200 ???? 7800002E 				e_b		do_prog
 201              	
 202              	
 203              	################################################################################
 204              	# 0x16 = erase shadow
 205              	################################################################################
 206 ???? 701D9816 	shadow_erase:		e_cmp16i	r29,0x16		# shadow erase code
 207 ???? E205     				se_bne		data_program
 208 ???? 78000179 				e_bl		enable_shadow		# enable shadow
 209 ???? 78000062 				e_b		do_erase
 210              	
 211              	
 212              	################################################################################
 213              	# 0x0F = program data
 214              	################################################################################
GAS LISTING boot.vleasm 			page 12


 215 ???? 701D980F 	data_program:		e_cmp16i	r29,0x0f		# data program?
 216 ???? E205     				se_bne		data_erase
 217 ???? 78000193 				e_bl		enable_dataflash	# enable DF
 218 ???? 78000012 				e_b		do_prog			# program
 219              	
 220              	
 221              	################################################################################
 222              	# 0x17 = erase data
 223              	################################################################################
 224 ???? 701D9817 	data_erase:		e_cmp16i	r29,0x17		# data erase
 225 ???? E2D5     				se_bne		main_xloop
 226 ???? 78000185 				e_bl		enable_dataflash	# enable DF
 227 ???? 78000046 				e_b		do_erase
 228              	
 229              	
 230              	################################################################################
 231              	# program routine
 232              	################################################################################
 233 ???? 780000E9 	do_prog:		e_bl		load_addr		# get addr word
 234              	
 235 ???? 4805     				se_li		r5,0			# counter
 236 ???? 7368E000 				e_lis		r27,0x4000		# RAM buffer pointer
 237 ???? 70E20000 				e_li		r7,0x1000
 238 ???? 447B     				se_or		r27,r7
 239              	
 240              				#now prog
 241 ???? 4907     				se_li		r7,0x10			#set PGM
 242 ???? D07C     				se_stw		r7,0(r28)
 243              	
 244 ???? C0EB     	do_prog_2:		se_lwz		r30,0(r27)		# get from buffer
 245 ???? D0E6     				se_stw		r30,0(r6)		# store
 246 ???? C1EB     				se_lwz		r30,4(r27)		# get from buffer
 247 ???? D1E6     				se_stw		r30,4(r6)		# store
 248              	
 249 ???? 4917     				se_li		r7,0x11			# set PGM + EHV
 250 ???? D07C     				se_stw		r7,0(r28)
 251              	
 252 ???? C07C     	wait_done_p:		se_lwz		r7,0(r28)		# get mcr
 253 ???? 4647     				se_and		r7,r4
 254 ???? 0C47     				se_cmp		r7,r4
 255 ???? E4FD     				se_blt		wait_done_p
 256              	
 257 ???? 4907     				se_li		r7,0x10			# clear EHV
 258 ???? D07C     				se_stw		r7,0(r28)
 259              	
 260 ???? 207B     				se_addi		r27,8			# increment src addr
 261 ???? 2076     				se_addi		r6,8			# increment dst addr
 262              	
 263 ???? 2075     				se_addi		r5,8			# counter
 264 ???? 70259800 				e_cmp16i	r5,block_size
 265 ???? E4EF     				se_blt		do_prog_2
 266              	
 267 ???? 480B     				se_li		r27,0x00		#clear PGM
 268 ???? D0BC     				se_stw		r27,0(r28)
 269              				
 270 ???? 780000C1 				e_bl		store_addr		#store addr
 271              	
GAS LISTING boot.vleasm 			page 13


 272 ???? E8B0     				se_b		main_xloop
 273              	
 274              	################################################################################
 275              	# erase routine
 276              	################################################################################
 277 ???? 4847     	do_erase:		se_li		r7,0x04			#set ERS
 278 ???? D07C     				se_stw		r7,0(r28)
 279              	
 280 ???? D066     				se_stw		r6,0(r6)		#dummy write
 281              	
 282 ???? 4857     				se_li		r7,0x05			#set EHV
 283 ???? D07C     				se_stw		r7,0(r28)
 284              	
 285 ???? C07C     	wait_done_e:		se_lwz		r7,0(r28)		#get mcr
 286 ???? 4647     				se_and		r7,r4
 287 ???? 0C47     				se_cmp		r7,r4
 288 ???? E4FD     				se_blt		wait_done_e
 289              	
 290 ???? 4847     				se_li		r7,0x04			#clear EHV
 291 ???? D07C     				se_stw		r7,0(r28)
 292              	
 293 ???? 4807     				se_li		r7,0x00			#clear ERS
 294 ???? D07C     				se_stw		r7,0(r28)
 295              	
 296 ???? 79FFFF44 				e_b		main_xloop		#goto main loop
 297              	
 298              	.if DEBUG_LED == 1
 299              	################################################################################
 300              	# set RED LED on and GREEN off
 301              	################################################################################
 302 ???? 182106F4 	led_red:		e_stwu		rsp,-12(rsp)
 303 ???? D081     				se_stw		r24,0(rsp)
 304 ???? D191     				se_stw		r25,4(rsp)
 305 ???? D2C1     				se_stw		r28,8(rsp)
 306 ???? 731EE7FC 				e_lis		r24,SIUL_BASE
 307 ???? 73220310 				e_li		r25,GPDO4
 308 ???? 4489     				se_or		r25,r24
 309 ???? 481C     				se_li		r28,0x01
 310 ???? 90C9     				se_stb		r28,0(r25)
 311 ???? 480C     				se_li		r28,0x00
 312 ???? 91C9     				se_stb		r28,1(r25)
 313 ???? C2C1     				se_lwz		r28,8(rsp)
 314 ???? C191     				se_lwz		r25,4(rsp)
 315 ???? C081     				se_lwz		r24,0(rsp)
 316 ???? 20B1     				se_addi		rsp,12
 317 ???? 0004     				se_blr
 318              	
 319              	################################################################################
 320              	# set RED LED off and GREEN on
 321              	################################################################################
 322 ???? 182106F4 	led_green:		e_stwu		rsp,-12(rsp)
 323 ???? D081     				se_stw		r24,0(rsp)
 324 ???? D191     				se_stw		r25,4(rsp)
 325 ???? D2C1     				se_stw		r28,8(rsp)
 326 ???? 731EE7FC 				e_lis		r24,SIUL_BASE
 327 ???? 73220310 				e_li		r25,GPDO4
 328 ???? 4489     				se_or		r25,r24
GAS LISTING boot.vleasm 			page 14


 329 ???? 480C     				se_li		r28,0x00
 330 ???? 90C9     				se_stb		r28,0(r25)
 331 ???? 481C     				se_li		r28,0x01
 332 ???? 91C9     				se_stb		r28,1(r25)
 333 ???? C2C1     				se_lwz		r28,8(rsp)
 334 ???? C191     				se_lwz		r25,4(rsp)
 335 ???? C081     				se_lwz		r24,0(rsp)
 336 ???? 20B1     				se_addi		rsp,12
 337 ???? 0004     				se_blr
 338              	.endif
 339              	
 340              	################################################################################
 341              	# wait for command
 342              	################################################################################
 343 ???? 182106FC 	wait_cmd:		e_stwu		rsp,-4(rsp)
 344 ???? D081     				se_stw		r24,0(rsp)
 345 ???? 73A00000 				e_li		r29,0x0000
 346 ???? 7308E000 				e_lis		r24,0x4000
 347 ???? 57B804F8 				e_stw		r29,0x04F8(r24)		#store 0
 348 ???? 53B804F8 	wait_cmd_1:		e_lwz		r29,0x04F8(r24)		#get data	
 349 ???? 701D9800 				e_cmp16i	r29,0x0000
 350 ???? E6FC     				se_beq		wait_cmd_1		#loop if no cmd
 351 ???? C081     				se_lwz		r24,0(rsp)
 352 ???? 2031     				se_addi		rsp,4
 353 ???? 0004     				se_blr
 354              	
 355              	
 356              	################################################################################
 357              	# wait1 n
 358              	################################################################################
 359 ???? 182106FC 	wait1:			e_stwu		rsp,-4(rsp)
 360 ???? D081     				se_stw		r24,0(rsp)
 361 ???? 73000000 				e_li		r24,0
 362 ???? 1F180001 	wait1_2:		e_add16i	r24,r24,1
 363 ???? 7018980A 				e_cmp16i	r24,10
 364 ???? E4FC     				se_blt		wait1_2
 365 ???? C081     				se_lwz		r24,0(rsp)
 366 ???? 2031     				se_addi		rsp,4
 367 ???? 0004     				se_blr
 368              	
 369              	################################################################################
 370              	# get a 32 bit addr to R6
 371              	################################################################################
 372 ???? 182106FC 	load_addr:		e_stwu		rsp,-4(rsp)
 373 ???? D081     				se_stw		r24,0(rsp)
 374 ???? 7308E000 				e_lis		r24,0x4000
 375 ???? 50D804FC 				e_lwz		r6,0x04FC(r24)
 376 ???? C081     				se_lwz		r24,0(rsp)
 377 ???? 2031     				se_addi		rsp,4
 378 ???? 0004     				se_blr
 379              	
 380              	################################################################################
 381              	# put a 32 bit addr from R6
 382              	################################################################################
 383 ???? 182106FC 	store_addr:		e_stwu		rsp,-4(rsp)
 384 ???? D081     				se_stw		r24,0(rsp)
 385 ???? 7308E000 				e_lis		r24,0x4000
GAS LISTING boot.vleasm 			page 15


 386 ???? 54D804FC 				e_stw		r6,0x04FC(r24)
 387 ???? C081     				se_lwz		r24,0(rsp)
 388 ???? 2031     				se_addi		rsp,4
 389 ???? 0004     				se_blr
 390              			
 391              	################################################################################
 392              	# enable main flash
 393              	################################################################################
 394 ???? 737FE7FC 	enable_main:		e_lis		r27,0xfffc		#unlock blocks in main flash
 395 ???? 70E00000 				e_li		r7,0x0000
 396 ???? 447B     				se_or		r27,r7
 397 ???? D1BA     				se_stw		r27,4(r26)		# LML
 398 ???? D3BA     				se_stw		r27,12(r26)		# SLL
 399              	
 400 ???? 7360E000 				e_lis		r27,0x0000		#unlock all blocks in main flash
 401 ???? 70E00000 				e_li		r7,0x0000
 402 ???? 447B     				se_or		r27,r7
 403 ???? D2BA     				se_stw		r27,8(r26)		# HBL
 404              	
 405              	
 406 ???? 737FE7FF 				e_lis		r27,0xffff		#lock all blocks in data flash
 407 ???? 70FF07FF 				e_li		r7,0xffff
 408 ???? 447B     				se_or		r27,r7
 409 ???? D1B9     				se_stw		r27,4(r25)		# LML
 410 ???? D2B9     				se_stw		r27,8(r25)		# HBL
 411 ???? D3B9     				se_stw		r27,12(r25)		# SLL
 412              	
 413 ???? 7360E003 				e_lis		r27,0x0003		# set LMS
 414 ???? 70FF07FF 				e_li		r7,0xffff
 415 ???? 447B     				se_or		r27,r7
 416 ???? D4BA     				se_stw		r27,0x10(r26)
 417              	
 418 ???? 70E0003F 				e_li		r7,0x003f		# set HBS
 419 ???? D5BA     				se_stw		r27,0x14(r26)
 420              	
 421 ???? 70C0E000 				e_lis		r6,0x0000		#base address
 422 ???? 01AC     				se_mr		r28,r26			# set pointer
 423 ???? 0004     				se_blr
 424              	
 425              	
 426              	################################################################################
 427              	# enable shadow flash
 428              	################################################################################
 429 ???? 737FE7EF 	enable_shadow:		e_lis		r27,shadow_unlock_hi	#unlock shadow block
 430 ???? 70FF07FF 				e_li		r7,shadow_unlock_lo
 431 ???? 447B     				se_or		r27,r7
 432 ???? D1BA     				se_stw		r27,4(r26)		# LML
 433 ???? D3BA     				se_stw		r27,12(r26)		# SLL
 434              	
 435 ???? 737FE7FF 				e_lis		r27,0xffff		#lock all blocks in data flash
 436 ???? 70FF07FF 				e_li		r7,0xffff
 437 ???? 447B     				se_or		r27,r7
 438 ???? D1B9     				se_stw		r27,4(r25)		# LML
 439 ???? D2B9     				se_stw		r27,8(r25)		# HBL
 440 ???? D3B9     				se_stw		r27,12(r25)		# SLL
 441 ???? D2BA     				se_stw		r27,8(r26)		# HBL (main)
 442              	
GAS LISTING boot.vleasm 			page 16


 443 ???? 70C0E020 				e_lis		r6,0x0020		#base address
 444 ???? 01AC     				se_mr		r28,r26			# set pointer
 445 ???? 0004     				se_blr
 446              	
 447              	
 448              	################################################################################
 449              	# enable shadow flash
 450              	################################################################################
 451 ???? 737FE7FF 	enable_dataflash:	e_lis		r27,0xffff		#lock shadow + main blocks
 452 ???? 70FF07FF 				e_li		r7,0xffff
 453 ???? 447B     				se_or		r27,r7
 454 ???? D1BA     				se_stw		r27,4(r26)		# LML
 455 ???? D2BA     				se_stw		r27,8(r26)		# HBL
 456 ???? D3BA     				se_stw		r27,12(r26)		# SLL
 457              	
 458 ???? 737FE7FF 				e_lis		r27,0xffff		# unlock all blocks in data flash
 459 ???? 70E00000 				e_li		r7,0x0000
 460 ???? 447B     				se_or		r27,r7
 461 ???? D1B9     				se_stw		r27,4(r25)		# LML
 462 ???? D3B9     				se_stw		r27,12(r25)		# SLL
 463              	
 464 ???? 7360E000 				e_lis		r27,0x0000		# unlock all blocks in data flash
 465 ???? 70E0003F 				e_li		r7,0x003F
 466 ???? 447B     				se_or		r27,r7
 467 ???? D2B9     				se_stw		r27,8(r25)		# HBL
 468              	
 469 ???? 7360E003 				e_lis		r27,0x0003		# set LMS
 470 ???? 70FF07FF 				e_li		r7,0xffff
 471 ???? 447B     				se_or		r27,r7
 472 ???? D4B9     				se_stw		r27,0x10(r25)
 473              	
 474 ???? 70E0003F 				e_li		r7,0x003f		# set HBS
 475 ???? D5B9     				se_stw		r27,0x14(r25)
 476              	
 477 ???? 70C0E080 				e_lis		r6,0x0080		# base address
 478 ???? 019C     				se_mr		r28,r25			# set pointer
 479 ???? 0004     				se_blr
 480              	
 481              	
 482              	################################################################################
 483              	# disbale all flash
 484              	################################################################################
 485 ???? 737FE7FF 	enable_none:		e_lis		r27,0xffff		# lock all blocks
 486 ???? 70FF07FF 				e_li		r7,0xffff
 487 ???? 447B     				se_or		r27,r7
 488 ???? D1BA     				se_stw		r27,4(r26)		# LML
 489 ???? D2BA     				se_stw		r27,8(r26)		# HBL
 490 ???? D3BA     				se_stw		r27,12(r26)		# SLL
 491 ???? D1B9     				se_stw		r27,4(r25)		# LML
 492 ???? D2B9     				se_stw		r27,8(r25)		# HBL
 493 ???? D3B9     				se_stw		r27,12(r25)		# SLL
 494              	
 495 ???? 70C0E080 				e_lis		r6,0x0080		# base address
 496 ???? 019C     				se_mr		r28,r25			# set pointer
 497 ???? 0004     				se_blr
 498              	
 499 ???? 00000000 				.org	0x4f8
GAS LISTING boot.vleasm 			page 17


 499      00000000 
 499      00000000 
 499      00000000 
 499      00000000 
 500              				
 501 ???? 1122     				.dc		0x1122
 502 ???? 3344     				.dc		0x3344
 503 ???? 5566     				.dc		0x5566
 504 ???? 7788     				.dc		0x7788
 505              	
